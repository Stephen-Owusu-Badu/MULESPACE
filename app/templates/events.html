{% extends "base.html" %}

{% block title %}Events{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1>Campus Events</h1>
        <p>Discover what's happening at Colby College</p>
    </div>
</div>

<div class="container">
    <div class="events-controls">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search events..." class="search-input">
        </div>
        <div class="filter-controls">
            <select id="departmentFilter" class="filter-select">
                <option value="">All Departments</option>
            </select>
            <select id="dateFilter" class="filter-select">
                <option value="">All Dates</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>
        </div>
    </div>

    <div id="eventsContainer" class="events-list">
        <div class="loading">Loading events...</div>
    </div>
</div>

<script>
let allEvents = [];
let departments = [];

// Load departments
fetch('/api/auth/departments')
    .then(response => response.json())
    .then(data => {
        departments = data.departments || [];
        const select = document.getElementById('departmentFilter');
        departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept.id;
            option.textContent = dept.name;
            select.appendChild(option);
        });
    });

// Load events with filters
function loadEvents() {
    const searchTerm = document.getElementById('searchInput').value;
    const departmentId = document.getElementById('departmentFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    let url = '/api/events?';
    const params = new URLSearchParams();
    
    if (searchTerm) params.append('search', searchTerm);
    if (departmentId) params.append('department_id', departmentId);
    
    // Add date filters
    if (dateFilter) {
        const now = new Date();
        let startDate, endDate;
        
        switch(dateFilter) {
            case 'today':
                startDate = new Date(now.setHours(0, 0, 0, 0)).toISOString();
                endDate = new Date(now.setHours(23, 59, 59, 999)).toISOString();
                break;
            case 'week':
                startDate = new Date().toISOString();
                endDate = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString();
                break;
            case 'month':
                startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59).toISOString();
                break;
        }
        
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
    }
    
    fetch(url + params.toString())
        .then(response => response.json())
        .then(data => {
            allEvents = data.events || [];
            displayEvents(allEvents);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('eventsContainer').innerHTML = 
                '<p class="error">Unable to load events</p>';
        });
}

function displayEvents(events) {
    const container = document.getElementById('eventsContainer');
    
    if (events.length === 0) {
        container.innerHTML = '<p class="no-events">No events found</p>';
        return;
    }
    
    container.innerHTML = events.map(event => {
        // Construct full datetime from date and time fields
        const eventDateTime = new Date(event.date + 'T' + event.start_time);
        
        return `
        <div class="event-card">
            <div class="event-card-header">
                <div class="event-date">
                    <div class="event-month">${eventDateTime.toLocaleDateString('en-US', {month: 'short'})}</div>
                    <div class="event-day">${eventDateTime.getDate()}</div>
                </div>
                <div class="event-header-content">
                    <h3>${event.title}</h3>
                    <span class="event-department">${event.department_name || event.department || 'No Department'}</span>
                </div>
            </div>
            <div class="event-card-body">
                <p class="event-description">${event.description}</p>
                <div class="event-meta">
                    <div class="meta-item">
                        <span>${eventDateTime.toLocaleString('en-US', {
                            weekday: 'short',
                            month: 'short', 
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit'
                        })}</span>
                    </div>
                    <div class="meta-item">
                        <span>${event.location}</span>
                    </div>
                    ${event.max_capacity ? `
                    <div class="meta-item">
                        <span>${event.registered_count || 0}/${event.max_capacity}</span>
                    </div>
                    ` : ''}
                </div>
            </div>
            <div class="event-card-footer">
                <a href="/events/${event.id}" class="btn btn-secondary">View Details</a>
            </div>
        </div>
        `;
    }).join('');
}

// Search functionality with debouncing
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        loadEvents();
    }, 300); // Wait 300ms after user stops typing
});

document.getElementById('departmentFilter').addEventListener('change', loadEvents);
document.getElementById('dateFilter').addEventListener('change', loadEvents);

// Initial load
loadEvents();
</script>
{% endblock %}
